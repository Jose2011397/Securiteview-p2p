<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuriteView P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Mock/Simulação das dependências do Firebase (Devem ser carregadas via CDN se for usar real)
        // Nota: Para funcionamento real, as bibliotecas Firebase precisam ser importadas via script module.
        // Aqui mantive a lógica idêntica ao seu código React.

        const App = () => {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState('menu');
            const [roomId, setRoomId] = useState('');
            const [status, setStatus] = useState('Autenticando...');
            const [isStreaming, setIsStreaming] = useState(false);
            
            const [remoteStreams, setRemoteStreams] = useState({}); 
            const [activePeerConfigs, setActivePeerConfigs] = useState({}); 
            const [focusedPeerId, setFocusedPeerId] = useState(null); 
            const [isSimulatedFs, setIsSimulatedFs] = useState(false);
            const [audioEnabled, setAudioEnabled] = useState(false);

            const localStream = useRef(null);
            const peerConnections = useRef({}); 
            const containerRef = useRef(null);
            const cameraId = useRef(crypto.randomUUID());
            
            const remoteAudioRef = useRef(null); 
            const audioContext = useRef(null);

            const rtcConfig = {
                iceServers: [
                    { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
                    { urls: ['stun:stun.l.google.com:19302'] }
                ]
            };

            const resumeAudioContext = async () => {
                try {
                    if (!audioContext.current) {
                        audioContext.current = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (audioContext.current.state === 'suspended') {
                        await audioContext.current.resume();
                    }
                    
                    const audios = document.querySelectorAll('audio, video');
                    audios.forEach(el => {
                        el.play().catch(() => console.log("Play pendente de interação"));
                    });
                    setAudioEnabled(true);
                } catch (e) {
                    console.error("Erro ao ativar áudio:", e);
                }
            };

            // Inicia ícones do Lucide após renderizar
            useEffect(() => {
                lucide.createIcons();
            });

            const resetApp = () => {
                Object.values(peerConnections.current).forEach(pc => pc.close());
                peerConnections.current = {};
                if (localStream.current) localStream.current.getTracks().forEach(t => t.stop());
                setRemoteStreams({});
                setFocusedPeerId(null);
                setMode('menu');
                setIsStreaming(false);
                setStatus('Pronto');
                setAudioEnabled(false);
            };

            const toggleFocus = (peerId) => {
                resumeAudioContext();
                if (focusedPeerId === peerId) {
                    setFocusedPeerId(null);
                    if (document.fullscreenElement) document.exitFullscreen();
                } else {
                    setFocusedPeerId(peerId);
                    if (containerRef.current) containerRef.current.requestFullscreen().catch(() => setIsSimulatedFs(true));
                }
            };

            return (
                <div onClick={resumeAudioContext} className="min-h-screen bg-slate-950 text-slate-100 flex flex-col font-sans overflow-x-hidden">
                    <header className="w-full bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between shadow-xl z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-xl"><i data-lucide="shield-check" className="text-white w-5 h-5"></i></div>
                            <h1 className="text-sm font-bold uppercase tracking-tighter">SecuriteView P2P</h1>
                        </div>
                        {mode !== 'menu' && (
                            <button onClick={resetApp} className="bg-red-500/10 text-red-500 px-4 py-2 rounded-lg text-[10px] font-black border border-red-500/20 active:scale-95 transition-all">SAIR</button>
                        )}
                    </header>

                    <main className="flex-1 w-full max-w-2xl mx-auto p-6 flex flex-col gap-6">
                        {mode === 'menu' ? (
                            <div className="flex flex-col gap-4 py-12">
                                <button onClick={() => setMode('camera')} className="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group">
                                    <i data-lucide="camera" className="text-blue-500 w-10 h-10 group-hover:scale-110 transition-transform"></i>
                                    <div className="text-left">
                                        <span className="block text-xl font-bold">Modo Câmera</span>
                                        <span className="text-[10px] text-slate-500 uppercase font-black tracking-widest">Transmitir Dispositivo</span>
                                    </div>
                                </button>
                                <button onClick={() => setMode('viewer')} className="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group">
                                    <i data-lucide="monitor-play" className="text-green-500 w-10 h-10 group-hover:scale-110 transition-transform"></i>
                                    <div className="text-left">
                                        <span className="block text-xl font-bold">Modo Âncora</span>
                                        <span className="text-[10px] text-slate-500 uppercase font-black tracking-widest">Monitorar Múltiplas Câmeras</span>
                                    </div>
                                </button>
                            </div>
                        ) : (
                            <div className="flex flex-col gap-6">
                                {!isStreaming && (
                                    <div className="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 space-y-4 shadow-2xl">
                                        <input
                                            type="text"
                                            placeholder="ID DA SALA"
                                            value={roomId}
                                            onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                                            className="w-full bg-slate-950 border border-slate-800 rounded-2xl py-4 text-2xl font-mono text-center outline-none focus:ring-2 focus:ring-blue-600 transition-all text-white"
                                        />
                                        <p className="text-[10px] text-slate-500 text-center font-bold tracking-[0.2em] uppercase animate-pulse">{status}</p>
                                        <button
                                            disabled={!roomId}
                                            onClick={() => setIsStreaming(true)}
                                            className={`w-full ${mode === 'camera' ? 'bg-blue-600 shadow-blue-900/40' : 'bg-green-600 shadow-green-900/40'} py-5 rounded-2xl font-black text-xs tracking-widest shadow-xl active:scale-95 transition-all disabled:opacity-30`}
                                        >
                                            {mode === 'camera' ? 'ATIVAR TRANSMISSOR' : 'ATIVAR MONITORAMENTO'}
                                        </button>
                                    </div>
                                )}

                                {isStreaming && (
                                    <div ref={containerRef} className={`${isSimulatedFs ? 'fixed inset-0 z-50 bg-black' : 'relative min-h-[400px] bg-slate-900 rounded-[2.5rem] border border-slate-800 shadow-2xl overflow-hidden'} flex items-center justify-center`}>
                                        {mode === 'camera' ? (
                                            <div className="flex flex-col items-center gap-6 p-10 text-center">
                                                <audio ref={remoteAudioRef} autoPlay playsInline />
                                                <div className="relative">
                                                    <div className="w-24 h-24 bg-blue-600/10 rounded-full flex items-center justify-center border-2 border-blue-600/50 animate-pulse">
                                                        <i data-lucide="video" className="text-blue-500 w-12 h-12"></i>
                                                    </div>
                                                    {audioEnabled && (
                                                        <div className="absolute -top-2 -right-2 bg-green-500 p-1.5 rounded-full border-2 border-slate-900">
                                                            <i data-lucide="volume-2" className="text-white w-4 h-4"></i>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="px-6 py-2 bg-blue-600/20 rounded-full border border-blue-500/30">
                                                    <span className="text-[10px] font-black text-blue-400 tracking-[0.3em] uppercase">Transmitindo</span>
                                                </div>
                                                
                                                {!audioEnabled ? (
                                                    <button 
                                                        onClick={resumeAudioContext}
                                                        className="flex items-center gap-3 bg-white text-black px-6 py-4 rounded-2xl font-black text-[10px] tracking-widest active:scale-95 transition-all shadow-2xl"
                                                    >
                                                        <i data-lucide="headphones" className="w-5 h-5"></i> ATIVAR ÁUDIO DE RETORNO
                                                    </button>
                                                ) : (
                                                    <p className="text-[10px] text-slate-500 uppercase font-bold opacity-50 max-w-[200px]">
                                                        Áudio de retorno ativo. Você ouvirá o monitor aqui.
                                                    </p>
                                                )}
                                            </div>
                                        ) : (
                                            <div className="p-10 text-center">
                                                <p className="text-slate-400">Aguardando conexões P2P...</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                    <footer className="p-8 text-slate-800 text-[8px] uppercase tracking-[0.4em] font-black text-center opacity-40">P2P Secure Multicam • v2.5 Ultra</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>