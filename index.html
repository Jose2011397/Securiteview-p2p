<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SecuriteView P2P</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, onSnapshot,
      collection, addDoc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, signInWithCustomToken,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* ================= CONFIG ================= */

    const firebaseConfig = JSON.parse(window.__firebase_config || "{}");
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = window.__app_id || "securiteview-p2p";

    const rtcConfig = {
      iceServers: [
        { urls: ["stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302"] },
        { urls: ["stun:stun.l.google.com:19302"] }
      ]
    };

    /* ================= STATE ================= */

    let user = null;
    let mode = "menu";
    let roomId = "";
    let status = "Autenticando...";
    let isStreaming = false;
    let audioEnabled = false;
    let focusedPeerId = null;
    let isSimulatedFs = false;

    const remoteStreams = {};
    const activePeerConfigs = {};
    const peerConnections = {};
    const cameraId = crypto.randomUUID();

    let localStream = null;
    let audioContext = null;

    /* ================= ELEMENTS ================= */

    const appEl = document.getElementById("app");
    const remoteAudio = document.getElementById("remoteAudio");
    const containerRef = document.getElementById("videoContainer");

    /* ================= AUDIO ================= */

    async function resumeAudioContext() {
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === "suspended") {
          await audioContext.resume();
        }
        document.querySelectorAll("audio,video").forEach(el => {
          el.play().catch(() => {});
        });
        audioEnabled = true;
        render();
      } catch {}
    }

    /* ================= AUTH ================= */

    async function initAuth() {
      try {
        if (window.__initial_auth_token) {
          await signInWithCustomToken(auth, window.__initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch {
        status = "Erro de autenticação";
      }
    }

    onAuthStateChanged(auth, u => {
      user = u;
      if (u) status = "Pronto";
      render();
    });

    initAuth();

    /* ================= FIREBASE HELPERS ================= */

    const peersCol = room =>
      collection(db, "artifacts", appId, "public", "data", "rooms", room, "peers");

    const peerDoc = (room, id) =>
      doc(db, "artifacts", appId, "public", "data", "rooms", room, "peers", id);

    /* ================= CAMERA MODE ================= */

    async function startCameraMode() {
      if (!roomId || !user) return;
      await resumeAudioContext();
      status = "Iniciando espião...";
      render();

      localStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: { echoCancellation: true, noiseSuppression: true }
      });

      const pc = new RTCPeerConnection(rtcConfig);
      peerConnections[cameraId] = pc;

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.addTransceiver("audio", { direction: "recvonly" });

      pc.ontrack = e => {
        if (e.track.kind === "audio") {
          remoteAudio.srcObject = e.streams[0];
          remoteAudio.play().catch(() => audioEnabled = false);
        }
      };

      const docRef = peerDoc(roomId, cameraId);
      const offerCandidates = collection(docRef, "offerCandidates");
      const answerCandidates = collection(docRef, "answerCandidates");

      pc.onicecandidate = e => {
        if (e.candidate) addDoc(offerCandidates, e.candidate.toJSON());
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await setDoc(docRef, {
        cameraId,
        offer,
        createdBy: user.uid,
        timestamp: Date.now(),
        controls: { zoom: 1, rotation: 0, remoteMic: true, anchorMic: true }
      });

      onSnapshot(docRef, async snap => {
        const d = snap.data();
        if (d?.answer && pc.signalingState !== "stable") {
          await pc.setRemoteDescription(d.answer);
        }
        if (d?.controls) {
          const v = localStream.getVideoTracks()[0];
          if (v?.getCapabilities?.().zoom) {
            v.applyConstraints({ advanced: [{ zoom: d.controls.zoom }] });
          }
          const a = localStream.getAudioTracks()[0];
          if (a) a.enabled = d.controls.remoteMic;
        }
      });

      onSnapshot(answerCandidates, s => {
        s.docChanges().forEach(c => {
          if (c.type === "added") pc.addIceCandidate(c.doc.data());
        });
      });

      isStreaming = true;
      status = "Transmissão Ativa";
      render();
    }

    /* ================= VIEWER MODE ================= */

    async function startViewerMode() {
      if (!roomId || !user) return;
      await resumeAudioContext();
      status = "Conectando...";
      render();

      let anchorStream = null;
      try {
        anchorStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {}

      onSnapshot(peersCol(roomId), snap => {
        snap.docChanges().forEach(async c => {
          if (c.type !== "added") return;
          const id = c.doc.id;
          const data = c.doc.data();
          if (peerConnections[id]) return;

          const pc = new RTCPeerConnection(rtcConfig);
          peerConnections[id] = pc;

          anchorStream?.getTracks().forEach(t => pc.addTrack(t, anchorStream));

          pc.ontrack = e => {
            remoteStreams[id] = e.streams[0];
            render();
          };

          const docRef = peerDoc(roomId, id);
          const offerCandidates = collection(docRef, "offerCandidates");
          const answerCandidates = collection(docRef, "answerCandidates");

          pc.onicecandidate = e => {
            if (e.candidate) addDoc(answerCandidates, e.candidate.toJSON());
          };

          await pc.setRemoteDescription(data.offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await updateDoc(docRef, { answer });

          onSnapshot(docRef, s => {
            activePeerConfigs[id] = s.data()?.controls || {};
            render();
          });

          onSnapshot(offerCandidates, s2 => {
            s2.docChanges().forEach(x => {
              if (x.type === "added") pc.addIceCandidate(x.doc.data());
            });
          });
        });
      });

      isStreaming = true;
      status = "Monitoramento Ativo";
      render();
    }

    /* ================= RENDER ================= */

    function render() {
      appEl.innerHTML = `
        <div class="min-h-screen bg-slate-950 text-white p-6">
          <h1 class="text-xl font-bold mb-4">SecuriteView P2P</h1>

          ${mode === "menu" ? `
            <button onclick="setMode('camera')" class="btn">Modo Câmera</button>
            <button onclick="setMode('viewer')" class="btn mt-3">Modo Âncora</button>
          ` : `
            <input class="input" placeholder="ID DA SALA"
              value="${roomId}"
              oninput="roomId=this.value.toUpperCase()" />
            <p class="text-xs mt-2">${status}</p>

            ${!isStreaming ? `
              <button onclick="${mode === "camera" ? "startCameraMode()" : "startViewerMode()"}"
                class="btn mt-4">ATIVAR</button>
            ` : `
              <div id="videos" class="grid mt-6 gap-3"></div>
            `}
          `}
        </div>
      `;

      const videos = document.getElementById("videos");
      if (videos) {
        Object.entries(remoteStreams).forEach(([id, stream]) => {
          const v = document.createElement("video");
          v.autoplay = true;
          v.playsInline = true;
          v.srcObject = stream;
          v.className = "rounded-xl bg-black";
          videos.appendChild(v);
        });
      }
    }

    window.setMode = m => { mode = m; render(); };
    window.startCameraMode = startCameraMode;
    window.startViewerMode = startViewerMode;

    render();
  </script>
</head>

<body onclick="resumeAudioContext?.()">
  <audio id="remoteAudio" autoplay playsinline></audio>
  <div id="app"></div>
</body>
</html>
