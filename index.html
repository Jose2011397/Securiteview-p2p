<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuriteView P2P Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col overflow-x-hidden">

    <!-- HEADER -->
    <header class="w-full bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between shadow-xl z-20">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl"><i data-lucide="shield-check" class="text-white w-5 h-5"></i></div>
            <h1 class="text-sm font-bold uppercase tracking-tighter">SecuriteView P2P</h1>
        </div>
        <button id="btnExit" class="hidden bg-red-500/10 text-red-500 px-4 py-2 rounded-lg text-[10px] font-black border border-red-500/20 active:scale-95 transition-all">SAIR</button>
    </header>

    <main class="flex-1 w-full max-w-2xl mx-auto p-6 flex flex-col gap-6">
        
        <!-- SECTION: PERMISSIONS -->
        <section id="secPermissions" class="flex flex-col items-center justify-center py-20 text-center gap-8">
            <div class="w-24 h-24 bg-blue-600/10 rounded-[2.5rem] flex items-center justify-center border border-blue-500/20 relative">
                <i data-lucide="lock" class="text-blue-500 w-10 h-10"></i>
                <div class="absolute -bottom-2 -right-2 bg-slate-950 p-1">
                    <i data-lucide="check-circle-2" class="text-green-500 w-6 h-6"></i>
                </div>
            </div>
            <div class="space-y-3">
                <h2 class="text-2xl font-bold">Acesso Necessário</h2>
                <p class="text-slate-400 text-sm max-w-[280px] mx-auto leading-relaxed">
                    Para funcionar corretamente, precisamos de acesso à sua <b>Câmera</b> e <b>Microfone</b>.
                </p>
            </div>
            <button id="btnGrantPermissions" class="w-full max-w-[280px] bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-black text-xs tracking-widest shadow-2xl shadow-blue-900/40 active:scale-95 transition-all">
                CONCEDER ACESSO AGORA
            </button>
            <p id="permStatus" class="text-[10px] text-slate-600 uppercase font-bold tracking-widest">Aguardando autorização</p>
        </section>

        <!-- SECTION: MENU -->
        <section id="secMenu" class="hidden flex flex-col gap-4 py-12">
            <button id="btnModeCamera" class="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group">
                <i data-lucide="camera" class="text-blue-500 w-10 h-10 group-hover:scale-110 transition-transform"></i>
                <div class="text-left">
                    <span class="block text-xl font-bold">Modo Câmera</span>
                    <span class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Transmitir Dispositivo</span>
                </div>
            </button>
            <button id="btnModeViewer" class="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group">
                <i data-lucide="monitor-play" class="text-green-500 w-10 h-10 group-hover:scale-110 transition-transform"></i>
                <div class="text-left">
                    <span class="block text-xl font-bold">Modo Âncora</span>
                    <span class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Monitorar Múltiplas Câmeras</span>
                </div>
            </button>
        </section>

        <!-- SECTION: SETUP ROOM -->
        <section id="secSetup" class="hidden flex flex-col gap-6">
            <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 space-y-4 shadow-2xl">
                <input type="text" id="inputRoomId" placeholder="ID DA SALA" class="w-full bg-slate-950 border border-slate-800 rounded-2xl py-4 text-2xl font-mono text-center outline-none focus:ring-2 focus:ring-blue-600 transition-all uppercase">
                <p id="setupStatus" class="text-[10px] text-slate-500 text-center font-bold tracking-[0.2em] uppercase animate-pulse">Pronto</p>
                <button id="btnStartStreaming" class="w-full py-5 rounded-2xl font-black text-xs tracking-widest shadow-xl active:scale-95 transition-all disabled:opacity-30">
                    ATIVAR
                </button>
            </div>
        </section>

        <!-- SECTION: STREAMING AREA -->
        <section id="secStreaming" class="hidden flex flex-col gap-6">
            <div id="streamingContainer" class="relative min-h-[400px] bg-slate-900 rounded-[2.5rem] border border-slate-800 shadow-2xl overflow-hidden flex items-center justify-center">
                <!-- CAMERA VIEW -->
                <div id="viewCamera" class="hidden flex flex-col items-center gap-6 p-10 text-center">
                    <audio id="remoteAudio" autoplay playsinline></audio>
                    <div class="relative">
                        <div class="w-24 h-24 bg-blue-600/10 rounded-full flex items-center justify-center border-2 border-blue-600/50 animate-pulse-slow">
                            <i data-lucide="video" class="text-blue-500 w-12 h-12"></i>
                        </div>
                        <div id="audioIndicator" class="hidden absolute -top-2 -right-2 bg-green-500 p-1.5 rounded-full border-2 border-slate-900">
                            <i data-lucide="volume-2" class="text-white w-3.5 h-3.5"></i>
                        </div>
                    </div>
                    <div class="px-6 py-2 bg-blue-600/20 rounded-full border border-blue-500/30">
                        <span class="text-[10px] font-black text-blue-400 tracking-[0.3em] uppercase">Transmitindo</span>
                    </div>
                    <button id="btnActivateReturnAudio" class="flex items-center gap-3 bg-white text-black px-6 py-4 rounded-2xl font-black text-[10px] tracking-widest active:scale-95 transition-all shadow-2xl">
                        <i data-lucide="headphones" class="w-4 h-4"></i> ATIVAR ÁUDIO DE RETORNO
                    </button>
                    <p id="returnAudioMsg" class="hidden text-[10px] text-slate-500 uppercase font-bold opacity-50 max-w-[200px]">
                        Áudio de retorno ativo. Você ouvirá o monitor aqui.
                    </p>
                </div>

                <!-- VIEWER GRID -->
                <div id="viewViewer" class="hidden w-full h-full p-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- Peer videos injected here -->
                </div>
            </div>
        </section>

    </main>

    <footer class="p-8 text-slate-800 text-[8px] uppercase tracking-[0.4em] font-black text-center opacity-40">P2P Secure Multicam • v2.5 Ultra</footer>

    <!-- FIREBASE SDKS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'securiteview-p2p';
        const rtcConfig = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        // STATE
        let currentUser = null;
        let currentMode = 'permissions'; 
        let currentRoomId = '';
        let localStream = null;
        let peerConnections = {};
        let cameraId = crypto.randomUUID();
        let audioContext = null;

        // DOM ELEMENTS
        const sections = {
            permissions: document.getElementById('secPermissions'),
            menu: document.getElementById('secMenu'),
            setup: document.getElementById('secSetup'),
            streaming: document.getElementById('secStreaming'),
            viewCamera: document.getElementById('viewCamera'),
            viewViewer: document.getElementById('viewViewer')
        };

        const updateUI = (mode) => {
            Object.keys(sections).forEach(k => sections[k].classList.add('hidden'));
            if (mode === 'permissions') sections.permissions.classList.remove('hidden');
            if (mode === 'menu') sections.menu.classList.remove('hidden');
            if (mode === 'camera' || mode === 'viewer') sections.setup.classList.remove('hidden');
            if (mode === 'streaming_camera') {
                sections.streaming.classList.remove('hidden');
                sections.viewCamera.classList.remove('hidden');
            }
            if (mode === 'streaming_viewer') {
                sections.streaming.classList.remove('hidden');
                sections.viewViewer.classList.remove('hidden');
            }
            document.getElementById('btnExit').classList.toggle('hidden', mode === 'permissions' || mode === 'menu');
            lucide.createIcons();
        };

        // AUDIO POLICY
        const resumeAudio = async () => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
            document.querySelectorAll('audio, video').forEach(el => {
                el.muted = false;
                el.play().catch(() => {});
            });
        };

        // AUTH
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, user => { currentUser = user; });
        initAuth();

        // PERMISSIONS
        document.getElementById('btnGrantPermissions').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                stream.getTracks().forEach(t => t.stop());
                currentMode = 'menu';
                updateUI('menu');
            } catch (e) {
                document.getElementById('permStatus').innerText = "Erro: Acesso Negado.";
            }
        };

        // NAVIGATION
        document.getElementById('btnModeCamera').onclick = () => {
            currentMode = 'camera';
            const btn = document.getElementById('btnStartStreaming');
            btn.innerText = 'ATIVAR TRANSMISSOR';
            btn.className = "w-full py-5 rounded-2xl font-black text-xs tracking-widest shadow-xl active:scale-95 transition-all bg-blue-600 shadow-blue-900/40";
            updateUI('camera');
        };

        document.getElementById('btnModeViewer').onclick = () => {
            currentMode = 'viewer';
            const btn = document.getElementById('btnStartStreaming');
            btn.innerText = 'ATIVAR MONITORAMENTO';
            btn.className = "w-full py-5 rounded-2xl font-black text-xs tracking-widest shadow-xl active:scale-95 transition-all bg-green-600 shadow-green-900/40";
            updateUI('viewer');
        };

        document.getElementById('btnExit').onclick = () => {
            location.reload(); // Forma mais segura de limpar todos os estados WebRTC
        };

        // START ENGINE
        document.getElementById('btnStartStreaming').onclick = async () => {
            currentRoomId = document.getElementById('inputRoomId').value.toUpperCase();
            if (!currentRoomId || !currentUser) return;
            await resumeAudio();
            
            if (currentMode === 'camera') startCameraMode();
            else startViewerMode();
        };

        // HELPERS
        const getPeerDoc = (room, pId) => doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room, 'peers', pId);
        const getPeersCol = (room) => collection(db, 'artifacts', appId, 'public', 'data', 'rooms', room, 'peers');

        // MODE: CAMERA
        async function startCameraMode() {
            const statusEl = document.getElementById('setupStatus');
            statusEl.innerText = "Iniciando espião...";
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" },
                    audio: { echoCancellation: true, noiseSuppression: true }
                });

                updateUI('streaming_camera');
                const pc = new RTCPeerConnection(rtcConfig);
                peerConnections[cameraId] = pc;
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                pc.addTransceiver('audio', { direction: 'recvonly' });

                pc.ontrack = (e) => {
                    if (e.track.kind === 'audio') {
                        const audio = document.getElementById('remoteAudio');
                        audio.srcObject = e.streams[0];
                        audio.muted = false;
                        audio.play().then(() => {
                            document.getElementById('audioIndicator').classList.remove('hidden');
                            document.getElementById('btnActivateReturnAudio').classList.add('hidden');
                            document.getElementById('returnAudioMsg').classList.remove('hidden');
                        }).catch(() => {});
                    }
                };

                const docRef = getPeerDoc(currentRoomId, cameraId);
                const offCand = collection(docRef, 'offerCandidates');
                const ansCand = collection(docRef, 'answerCandidates');

                pc.onicecandidate = e => e.candidate && addDoc(offCand, e.candidate.toJSON());

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await setDoc(docRef, {
                    cameraId, offer: { sdp: offer.sdp, type: offer.type },
                    createdBy: currentUser.uid, timestamp: Date.now(),
                    controls: { zoom: 1, rotation: 0, remoteMic: true, anchorMic: true }
                });

                onSnapshot(docRef, async snap => {
                    const data = snap.data();
                    if (!data) return;
                    if (data.answer && pc.signalingState !== 'stable') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                    if (data.controls) {
                        const { zoom, remoteMic } = data.controls;
                        const vTrack = localStream.getVideoTracks()[0];
                        if (vTrack && vTrack.getCapabilities?.().zoom) {
                            vTrack.applyConstraints({ advanced: [{ zoom }] }).catch(() => {});
                        }
                        const aTrack = localStream.getAudioTracks()[0];
                        if (aTrack) aTrack.enabled = remoteMic;
                    }
                });

                onSnapshot(ansCand, snap => {
                    snap.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())).catch(()=>{}))
                });

            } catch (e) { statusEl.innerText = "Erro Hardware"; }
        }

        // MODE: VIEWER
        async function startViewerMode() {
            updateUI('streaming_viewer');
            let anchorStream = null;
            try {
                anchorStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localStream = anchorStream;
            } catch (e) { console.warn("Sem mic monitor"); }

            onSnapshot(getPeersCol(currentRoomId), snap => {
                snap.docChanges().forEach(async change => {
                    if (change.type !== 'added') return;
                    const pId = change.doc.id;
                    const pData = change.doc.data();
                    if (peerConnections[pId] || !pData.offer) return;

                    const pc = new RTCPeerConnection(rtcConfig);
                    peerConnections[pId] = pc;
                    if (anchorStream) anchorStream.getTracks().forEach(t => pc.addTrack(t, anchorStream));

                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = "relative bg-black rounded-3xl overflow-hidden aspect-video border border-white/5";
                    const video = document.createElement('video');
                    video.autoplay = true;
                    video.playsInline = true;
                    video.className = "w-full h-full object-contain";
                    videoWrapper.appendChild(video);
                    document.getElementById('viewViewer').appendChild(videoWrapper);

                    pc.ontrack = e => {
                        video.srcObject = e.streams[0];
                        video.muted = false;
                        video.play().catch(() => {});
                    };

                    const docRef = getPeerDoc(currentRoomId, pId);
                    const offCand = collection(docRef, 'offerCandidates');
                    const ansCand = collection(docRef, 'answerCandidates');

                    pc.onicecandidate = e => e.candidate && addDoc(ansCand, e.candidate.toJSON());
                    await pc.setRemoteDescription(new RTCSessionDescription(pData.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await updateDoc(docRef, { answer: { sdp: answer.sdp, type: answer.type } });

                    onSnapshot(docRef, s => {
                        const d = s.data();
                        if (d?.controls && anchorStream) {
                            anchorStream.getAudioTracks().forEach(t => t.enabled = !!d.controls.anchorMic);
                            video.style.transform = `rotate(${d.controls.rotation}deg) scale(${d.controls.zoom})`;
                        }
                    });

                    onSnapshot(offCand, s => s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())).catch(()=>{})));
                });
            });
        }

        document.getElementById('btnActivateReturnAudio').onclick = resumeAudio;
        window.addEventListener('click', resumeAudio);
        lucide.createIcons();
    </script>
</body>
</html>