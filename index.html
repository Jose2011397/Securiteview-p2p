import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getFirestore,
  doc,
  setDoc,
  onSnapshot,
  collection,
  addDoc,
  updateDoc,
  getDoc
} from 'firebase/firestore';
import {
  getAuth,
  signInAnonymously,
  signInWithCustomToken,
  onAuthStateChanged
} from 'firebase/auth';
import {
  Camera,
  ShieldCheck,
  Video,
  MonitorPlay,
  Plus,
  Minus,
  Mic,
  MicOff,
  Volume2,
  VolumeX,
  Maximize,
  Minimize,
  RotateCw,
  Headphones
} from 'lucide-react';

/* ================= CONFIGURAÇÃO ================= */

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'securiteview-p2p';

const rtcConfig = {
  iceServers: [
    { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
  ]
};

/* ================= APP ================= */

export default function App() {
  const [user, setUser] = useState(null);
  const [mode, setMode] = useState('menu');
  const [roomId, setRoomId] = useState('');
  const [status, setStatus] = useState('Autenticando...');
  const [isStreaming, setIsStreaming] = useState(false);

  const [permissionsGranted, setPermissionsGranted] = useState(false);
  const [permissionError, setPermissionError] = useState('');

  const [remoteStreams, setRemoteStreams] = useState({});
  const [activePeerConfigs, setActivePeerConfigs] = useState({});
  const [focusedPeerId, setFocusedPeerId] = useState(null);
  const [isSimulatedFs, setIsSimulatedFs] = useState(false);
  const [audioEnabled, setAudioEnabled] = useState(false);

  const localStream = useRef(null);
  const peerConnections = useRef({});
  const containerRef = useRef(null);
  const cameraId = useRef('a917e22e-ea80-454c-af30-2a637498d1f5');
  const remoteAudioRef = useRef(null);
  const audioContext = useRef(null);

  /* ================= AUDIO POLICY ================= */

  const resumeAudioContext = async () => {
    if (!audioContext.current) {
      audioContext.current = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.current.state === 'suspended') {
      await audioContext.current.resume();
    }
    document.querySelectorAll('audio,video').forEach(el => el.play().catch(() => {}));
    setAudioEnabled(true);
  };

  /* ================= PERMISSÕES (APK) ================= */

  const requestPermissions = async () => {
    try {
      setPermissionError('');
      await resumeAudioContext();

      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });

      stream.getTracks().forEach(t => t.stop());
      setPermissionsGranted(true);
    } catch (e) {
      setPermissionError('Permissão de câmera ou microfone negada');
      setPermissionsGranted(false);
    }
  };

  /* ================= AUTH ================= */

  useEffect(() => {
    const init = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined') {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch {
        setStatus('Erro de autenticação');
      }
    };
    init();
    return onAuthStateChanged(auth, u => {
      setUser(u);
      if (u) setStatus('Pronto');
    });
  }, []);

  const getPeerDoc = (room, id) =>
    doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room, 'peers', id);

  const getPeersCol = room =>
    collection(db, 'artifacts', appId, 'public', 'data', 'rooms', room, 'peers');

  /* ================= CAMERA ================= */

  const startCameraMode = async () => {
    if (!permissionsGranted) return;
    await resumeAudioContext();

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' },
      audio: true
    });

    localStream.current = stream;
    setIsStreaming(true);

    const pc = new RTCPeerConnection(rtcConfig);
    peerConnections.current[cameraId.current] = pc;
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    pc.addTransceiver('audio', { direction: 'recvonly' });

    pc.ontrack = e => {
      if (remoteAudioRef.current) {
        remoteAudioRef.current.srcObject = e.streams[0];
        remoteAudioRef.current.play().catch(() => setAudioEnabled(false));
      }
    };

    const peerRef = getPeerDoc(roomId, cameraId.current);
    const offerCol = collection(peerRef, 'offerCandidates');
    const answerCol = collection(peerRef, 'answerCandidates');

    pc.onicecandidate = e => e.candidate && addDoc(offerCol, e.candidate.toJSON());

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await setDoc(peerRef, {
      offer,
      controls: { zoom: 1, rotation: 0, remoteMic: true, anchorMic: true }
    });

    onSnapshot(peerRef, s => {
      const d = s.data();
      if (d?.answer) pc.setRemoteDescription(d.answer);
      if (d?.controls) {
        const v = stream.getVideoTracks()[0];
        if (v?.getCapabilities?.().zoom)
          v.applyConstraints({ advanced: [{ zoom: d.controls.zoom }] }).catch(() => {});
        const a = stream.getAudioTracks()[0];
        if (a) a.enabled = d.controls.remoteMic;
      }
    });

    onSnapshot(answerCol, s =>
      s.docChanges().forEach(c => pc.addIceCandidate(c.doc.data()).catch(() => {}))
    );

    setStatus('Transmissão Ativa');
  };

  /* ================= VIEWER ================= */

  const startViewerMode = async () => {
    if (!permissionsGranted) return;
    await resumeAudioContext();
    setIsStreaming(true);

    const anchorStream = await navigator.mediaDevices.getUserMedia({ audio: true }).catch(() => null);
    localStream.current = anchorStream;

    onSnapshot(getPeersCol(roomId), snap => {
      snap.docChanges().forEach(async ch => {
        if (ch.type !== 'added') return;
        const id = ch.doc.id;
        if (peerConnections.current[id]) return;

        const pc = new RTCPeerConnection(rtcConfig);
        peerConnections.current[id] = pc;

        anchorStream?.getTracks().forEach(t => pc.addTrack(t, anchorStream));
        pc.ontrack = e => setRemoteStreams(p => ({ ...p, [id]: e.streams[0] }));

        const ref = getPeerDoc(roomId, id);
        const offerCol = collection(ref, 'offerCandidates');
        const answerCol = collection(ref, 'answerCandidates');

        pc.onicecandidate = e => e.candidate && addDoc(answerCol, e.candidate.toJSON());
        await pc.setRemoteDescription(ch.doc.data().offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await updateDoc(ref, { answer });

        onSnapshot(ref, s => setActivePeerConfigs(p => ({ ...p, [id]: s.data()?.controls })));
        onSnapshot(offerCol, s =>
          s.docChanges().forEach(c => pc.addIceCandidate(c.doc.data()).catch(() => {}))
        );
      });
    });

    setStatus('Monitoramento Ativo');
  };

  /* ================= RESET ================= */

  const resetApp = () => {
    Object.values(peerConnections.current).forEach(pc => pc.close());
    peerConnections.current = {};
    localStream.current?.getTracks().forEach(t => t.stop());
    setRemoteStreams({});
    setIsStreaming(false);
    setPermissionsGranted(false);
    setMode('menu');
  };

  /* ================= UI ================= */

  return (
    <div onClick={resumeAudioContext} className="min-h-screen bg-slate-950 text-slate-100">
      <header className="p-4 flex justify-between bg-slate-900">
        <h1 className="font-bold">SecuriteView P2P</h1>
        {mode !== 'menu' && <button onClick={resetApp}>SAIR</button>}
      </header>

      <main className="p-6">
        {mode === 'menu' ? (
          <>
            <button onClick={() => setMode('camera')}>Modo Câmera</button>
            <button onClick={() => setMode('viewer')}>Modo Âncora</button>
          </>
        ) : (
          <>
            {!isStreaming && (
              <>
                <input value={roomId} onChange={e => setRoomId(e.target.value)} />
                <button
                  onClick={
                    !permissionsGranted
                      ? requestPermissions
                      : mode === 'camera'
                        ? startCameraMode
                        : startViewerMode
                  }
                >
                  {!permissionsGranted
                    ? 'PERMITIR CÂMERA E MICROFONE'
                    : mode === 'camera'
                      ? 'ATIVAR TRANSMISSOR'
                      : 'ATIVAR MONITOR'}
                </button>
                {permissionError && <p>{permissionError}</p>}
              </>
            )}
            {isStreaming && <p>{status}</p>}
          </>
        )}
      </main>
    </div>
  );
}
