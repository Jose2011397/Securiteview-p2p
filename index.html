<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SecuriteView P2P - Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; color: #f1f5f9; margin: 0; font-family: ui-sans-serif, system-ui; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        window.FB = { initializeApp, getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, getDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* ================= CONFIGURAÇÃO ================= */
        // PREENCHA AQUI COM SEUS DADOS DO FIREBASE
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "ID",
            appId: "APP_ID"
        };

        const rtcConfig = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // Componente de Ícone para rodar no navegador
        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const icon = window.lucide.icons[iconName];
                    if (icon) {
                        const svg = icon.toSvg({ width: size, height: size, class: className });
                        iconRef.current.innerHTML = svg;
                    }
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState('menu');
            const [roomId, setRoomId] = useState('');
            const [status, setStatus] = useState('Iniciando...');
            const [isStreaming, setIsStreaming] = useState(false);
            const [remoteStreams, setRemoteStreams] = useState({});
            const [activePeerConfigs, setActivePeerConfigs] = useState({});
            const [focusedPeerId, setFocusedPeerId] = useState(null);
            const [audioEnabled, setAudioEnabled] = useState(false);

            const localStream = useRef(null);
            const peerConnections = useRef({});
            const containerRef = useRef(null);
            const cameraId = useRef(crypto.randomUUID());
            const remoteAudioRef = useRef(null);

            // Inicializar Firebase
            useEffect(() => {
                if (window.FB) {
                    const app = window.FB.initializeApp(firebaseConfig);
                    const _db = window.FB.getFirestore(app);
                    const _auth = window.FB.getAuth(app);
                    setDb(_db);
                    setAuth(_auth);

                    window.FB.onAuthStateChanged(_auth, (u) => {
                        if (u) { setUser(u); setStatus('Pronto'); }
                        else { window.FB.signInAnonymously(_auth).catch(e => setStatus("Erro de Auth")); }
                    });
                }
            }, []);

            const resumeAudioContext = async () => {
                const audios = document.querySelectorAll('audio, video');
                audios.forEach(el => el.play().catch(() => {}));
                setAudioEnabled(true);
            };

            /* ================= FUNÇÕES CORE ================= */

            const startCameraMode = async () => {
                if (!roomId || !user) return;
                setStatus("Acessando Câmera...");
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" },
                        audio: { echoCancellation: true }
                    });
                    localStream.current = stream;
                    setIsStreaming(true);

                    const pc = new RTCPeerConnection(rtcConfig);
                    peerConnections.current[cameraId.current] = pc;
                    stream.getTracks().forEach(t => pc.addTrack(t, stream));

                    const peerDocRef = window.FB.doc(db, 'rooms', roomId, 'peers', cameraId.current);
                    
                    pc.onicecandidate = e => {
                        if (e.candidate) {
                            window.FB.addDoc(window.FB.collection(peerDocRef, 'offerCandidates'), e.candidate.toJSON());
                        }
                    };

                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    await window.FB.setDoc(peerDocRef, {
                        offer: { sdp: offer.sdp, type: offer.type },
                        timestamp: Date.now(),
                        controls: { zoom: 1, rotation: 0, remoteMic: true }
                    });

                    window.FB.onSnapshot(peerDocRef, async (snap) => {
                        const data = snap.data();
                        if (data?.answer && pc.signalingState !== 'stable') {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        }
                    });

                    setStatus("Transmitindo...");
                } catch (e) {
                    setStatus("Erro ao abrir câmera");
                    console.error(e);
                }
            };

            const startViewerMode = async () => {
                if (!roomId || !user) return;
                setIsStreaming(true);
                setStatus("Monitorando...");

                const peersCol = window.FB.collection(db, 'rooms', roomId, 'peers');
                window.FB.onSnapshot(peersCol, snap => {
                    snap.docChanges().forEach(async change => {
                        if (change.type === 'added') {
                            const peerId = change.doc.id;
                            const peerData = change.doc.data();
                            if (peerConnections.current[peerId]) return;

                            const pc = new RTCPeerConnection(rtcConfig);
                            peerConnections.current[peerId] = pc;

                            pc.ontrack = e => {
                                setRemoteStreams(prev => ({ ...prev, [peerId]: e.streams[0] }));
                            };

                            const peerDocRef = window.FB.doc(db, 'rooms', roomId, 'peers', peerId);
                            
                            pc.onicecandidate = e => {
                                if (e.candidate) {
                                    window.FB.addDoc(window.FB.collection(peerDocRef, 'answerCandidates'), e.candidate.toJSON());
                                }
                            };

                            await pc.setRemoteDescription(new RTCSessionDescription(peerData.offer));
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            await window.FB.updateDoc(peerDocRef, { answer: { sdp: answer.sdp, type: answer.type } });
                        }
                    });
                });
            };

            const resetApp = () => window.location.reload();

            return (
                <div onClick={resumeAudioContext} className="min-h-screen bg-slate-950 text-slate-100 flex flex-col font-sans overflow-x-hidden">
                    <header className="w-full bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between shadow-xl z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-xl"><LucideIcon name="shield-check" size={20} className="text-white" /></div>
                            <h1 className="text-sm font-bold uppercase tracking-tighter">SecuriteView P2P</h1>
                        </div>
                        {mode !== 'menu' && (
                            <button onClick={resetApp} className="bg-red-500/10 text-red-500 px-4 py-2 rounded-lg text-[10px] font-black border border-red-500/20 active:scale-95 transition-all">SAIR</button>
                        )}
                    </header>

                    <main className="flex-1 w-full max-w-2xl mx-auto p-6 flex flex-col gap-6">
                        {mode === 'menu' ? (
                            <div className="flex flex-col gap-4 py-12">
                                <button onClick={() => setMode('camera')} className="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group">
                                    <LucideIcon name="camera" size={40} className="text-blue-500 group-hover:scale-110 transition-transform" />
                                    <div className="text-left">
                                        <span className="block text-xl font-bold">Modo Câmera</span>
                                        <span className="text-[10px] text-slate-500 uppercase font-black tracking-widest">Transmitir Dispositivo</span>
                                    </div>
                                </button>
                                <button onClick={() => setMode('viewer')} className="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group">
                                    <LucideIcon name="monitor-play" size={40} className="text-green-500 group-hover:scale-110 transition-transform" />
                                    <div className="text-left">
                                        <span className="block text-xl font-bold">Modo Âncora</span>
                                        <span className="text-[10px] text-slate-500 uppercase font-black tracking-widest">Monitorar Múltiplas Câmeras</span>
                                    </div>
                                </button>
                            </div>
                        ) : (
                            <div className="flex flex-col gap-6">
                                {!isStreaming && (
                                    <div className="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 space-y-4 shadow-2xl">
                                        <input
                                            type="text"
                                            placeholder="ID DA SALA"
                                            value={roomId}
                                            onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                                            className="w-full bg-slate-950 border border-slate-800 rounded-2xl py-4 text-2xl font-mono text-center outline-none focus:ring-2 focus:ring-blue-600 transition-all text-white"
                                        />
                                        <p className="text-[10px] text-slate-500 text-center font-bold tracking-[0.2em] uppercase animate-pulse">{status}</p>
                                        <button
                                            disabled={!roomId || !user}
                                            onClick={mode === 'camera' ? startCameraMode : startViewerMode}
                                            className={`w-full ${mode === 'camera' ? 'bg-blue-600' : 'bg-green-600'} py-5 rounded-2xl font-black text-xs tracking-widest active:scale-95 transition-all disabled:opacity-30`}
                                        >
                                            {mode === 'camera' ? 'ATIVAR TRANSMISSOR' : 'ATIVAR MONITORAMENTO'}
                                        </button>
                                    </div>
                                )}

                                {isStreaming && (
                                    <div className="relative min-h-[400px] bg-slate-900 rounded-[2.5rem] border border-slate-800 shadow-2xl overflow-hidden flex items-center justify-center">
                                        {mode === 'camera' ? (
                                            <div className="flex flex-col items-center gap-6 p-10 text-center">
                                                <div className="w-24 h-24 bg-blue-600/10 rounded-full flex items-center justify-center border-2 border-blue-600/50 animate-pulse">
                                                    <LucideIcon name="video" size={48} className="text-blue-500" />
                                                </div>
                                                <div className="px-6 py-2 bg-blue-600/20 rounded-full border border-blue-500/30">
                                                    <span className="text-[10px] font-black text-blue-400 tracking-[0.3em] uppercase">Transmitindo</span>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="w-full h-full p-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                                                {Object.entries(remoteStreams).map(([id, stream]) => (
                                                    <div key={id} className="relative aspect-video bg-black rounded-3xl overflow-hidden flex items-center justify-center border border-white/5">
                                                        <video 
                                                            autoPlay 
                                                            playsInline 
                                                            ref={el => { if (el) el.srcObject = stream; }}
                                                            className="w-full h-full object-contain"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                    <footer className="p-8 text-slate-800 text-[8px] uppercase tracking-[0.4em] font-black text-center opacity-40">P2P Secure Multicam • v2.5 Ultra</footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>