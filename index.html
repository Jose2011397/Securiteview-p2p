<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#020617">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>SecuriteView P2P Ultra</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
body { font-family: 'Inter', sans-serif; }
.animate-pulse-slow { animation: pulse 3s cubic-bezier(.4,0,.6,1) infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
video { object-fit: contain; }
</style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col overflow-x-hidden">

<header class="bg-slate-900 border-b border-slate-800 px-6 py-4 flex justify-between items-center">
  <div class="flex items-center gap-3">
    <div class="bg-blue-600 p-2 rounded-xl"><i data-lucide="shield-check"></i></div>
    <h1 class="text-sm font-bold uppercase">SecuriteView P2P</h1>
  </div>
  <button id="btnExit" class="hidden text-red-400 text-xs font-black">SAIR</button>
</header>

<main class="flex-1 max-w-2xl mx-auto p-6 flex flex-col gap-6">

<section id="secPermissions" class="text-center flex flex-col gap-6 items-center justify-center py-20">
  <h2 class="text-2xl font-bold">Permiss√µes Necess√°rias</h2>
  <p class="text-slate-400 text-sm">C√¢mera e microfone s√£o necess√°rios.</p>
  <button id="btnGrantPermissions" class="bg-blue-600 px-6 py-4 rounded-xl font-black text-xs">
    CONCEDER ACESSO
  </button>
  <span id="permStatus" class="text-xs text-slate-500">Aguardando autoriza√ß√£o</span>
</section>

<section id="secMenu" class="hidden flex flex-col gap-4">
  <button id="btnModeCamera" class="p-6 bg-slate-900 rounded-3xl flex gap-4 items-center">
    <i data-lucide="camera" class="text-blue-500"></i>
    <span class="font-bold">Modo C√¢mera</span>
  </button>
  <button id="btnModeViewer" class="p-6 bg-slate-900 rounded-3xl flex gap-4 items-center">
    <i data-lucide="monitor-play" class="text-green-500"></i>
    <span class="font-bold">Modo √Çncora</span>
  </button>
</section>

<section id="secSetup" class="hidden">
  <input id="inputRoomId" placeholder="ID DA SALA" class="w-full text-center text-xl p-4 bg-slate-900 rounded-xl uppercase">
  <button id="btnStartStreaming" class="mt-4 w-full bg-blue-600 py-4 rounded-xl font-black text-xs">
    ATIVAR
  </button>
</section>

<section id="secStreaming" class="hidden">
  <div id="viewCamera" class="hidden text-center">
    <audio id="remoteAudio" autoplay playsinline></audio>
    <p class="text-xs text-blue-400 uppercase font-bold">Transmitindo</p>
  </div>
  <div id="viewViewer" class="hidden grid grid-cols-1 gap-2"></div>
</section>

</main>

<footer class="text-center text-[8px] text-slate-600 py-4">SecuriteView P2P ‚Ä¢ v2.5</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, updateDoc, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* üî• FIREBASE CONFIG (OFICIAL) */
const firebaseConfig = {
  apiKey: "AIzaSyAuDL0Y0BAQKlqN2_ctSzQCA4E5RXtFP_4",
  authDomain: "securiteview-p2p.firebaseapp.com",
  projectId: "securiteview-p2p",
  storageBucket: "securiteview-p2p.firebasestorage.app",
  messagingSenderId: "1021051446315",
  appId: "1:1021051446315:web:d49d774565223fa838b66e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

await signInAnonymously(auth);

/* üîä UNLOCK AUDIO (ANDROID / APK) */
const unlockAudio = async () => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  if (ctx.state === "suspended") await ctx.resume();
};
window.addEventListener("click", unlockAudio, { once:true });
window.addEventListener("touchstart", unlockAudio, { once:true });

/* UI */
const sec = id => document.getElementById(id);
const show = (...ids) => {
  ["secPermissions","secMenu","secSetup","secStreaming","viewCamera","viewViewer"]
  .forEach(i => sec(i).classList.add("hidden"));
  ids.forEach(i => sec(i).classList.remove("hidden"));
  lucide.createIcons();
};

sec("btnGrantPermissions").onclick = async () => {
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    s.getTracks().forEach(t=>t.stop());
    show("secMenu");
  } catch {
    sec("permStatus").innerText = "Permiss√£o negada";
  }
};

let mode = "";

sec("btnModeCamera").onclick = () => { mode="camera"; show("secSetup"); };
sec("btnModeViewer").onclick = () => { mode="viewer"; show("secSetup"); };

sec("btnStartStreaming").onclick = async () => {
  const room = sec("inputRoomId").value.trim().toUpperCase();
  if (!room) return;

  if (mode === "camera") startCamera(room);
  else startViewer(room);
};

/* üîó HELPERS */
const peerDoc = (r,id)=>doc(db,"rooms",r,"peers",id);

/* üì∑ CAMERA MODE */
async function startCamera(room){
  show("secStreaming","viewCamera");

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" } },
    audio:true
  });

  const pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  const id = crypto.randomUUID();
  const ref = peerDoc(room,id);
  const off = collection(ref,"offerCandidates");
  const ans = collection(ref,"answerCandidates");

  pc.onicecandidate = e => e.candidate && addDoc(off,e.candidate.toJSON());

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await setDoc(ref,{ offer });

  onSnapshot(ref,s=>{
    const d=s.data();
    if(d?.answer) pc.setRemoteDescription(d.answer);
  });

  onSnapshot(ans,s=>s.docChanges().forEach(c=>{
    if(c.type==="added") pc.addIceCandidate(c.doc.data());
  }));
}

/* üëÅ VIEWER MODE */
function startViewer(room){
  show("secStreaming","viewViewer");

  onSnapshot(collection(db,"rooms",room,"peers"), snap=>{
    snap.docChanges().forEach(async c=>{
      if(c.type!=="added") return;
      const data=c.doc.data();
      if(!data.offer) return;

      const pc=new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
      const v=document.createElement("video");
      v.autoplay=true; v.playsInline=true;
      sec("viewViewer").appendChild(v);

      pc.ontrack=e=>{ v.srcObject=e.streams[0]; };

      await pc.setRemoteDescription(data.offer);
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      await updateDoc(peerDoc(room,c.doc.id),{ answer:ans });
    });
  });
}

show("secPermissions");
</script>
</body>
</html>
