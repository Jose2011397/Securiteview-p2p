<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SecuriteView P2P Ultra</title>
    
    <!-- PWA / Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overscroll-behavior: none;
        }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Ajuste para Notch em iPhones e Androids modernos */
        header { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col overflow-x-hidden">

    <!-- HEADER -->
    <header class="w-full bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between shadow-xl z-20 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/20">
                <i data-lucide="shield-check" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="text-sm font-bold uppercase tracking-tighter">SecuriteView P2P</h1>
        </div>
        <button id="btnExit" class="hidden bg-red-500/10 text-red-500 px-4 py-2 rounded-lg text-[10px] font-black border border-red-500/20 active:scale-95 transition-all uppercase">Sair</button>
    </header>

    <main class="flex-1 w-full max-w-2xl mx-auto p-6 flex flex-col gap-6">
        
        <!-- SECTION: PERMISSIONS (CRITICAL FOR MOBILE APP) -->
        <section id="secPermissions" class="flex flex-col items-center justify-center py-10 text-center gap-8 animate-in fade-in duration-500">
            <div class="w-28 h-28 bg-blue-600/10 rounded-[2.5rem] flex items-center justify-center border border-blue-500/20 relative shadow-2xl">
                <i data-lucide="video" class="text-blue-500 w-12 h-12"></i>
                <div class="absolute -bottom-1 -right-1 bg-blue-600 p-2 rounded-full border-4 border-slate-950">
                    <i data-lucide="mic" class="text-white w-5 h-5"></i>
                </div>
            </div>
            <div class="space-y-4">
                <h2 class="text-3xl font-black tracking-tight">Permissões do Sistema</h2>
                <p class="text-slate-400 text-sm max-w-[300px] mx-auto leading-relaxed">
                    Para este app funcionar como uma câmera de segurança P2P, você deve <b>permitir o acesso</b> quando o sistema solicitar.
                </p>
            </div>
            
            <div class="w-full max-w-[300px] space-y-3">
                <button id="btnGrantPermissions" class="w-full bg-blue-600 hover:bg-blue-500 py-6 rounded-2xl font-black text-xs tracking-[0.2em] shadow-2xl shadow-blue-900/40 active:scale-95 transition-all uppercase">
                    Solicitar Acesso
                </button>
                <div id="errorBox" class="hidden p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-[10px] font-bold uppercase tracking-widest">
                    Acesso negado. Por favor, habilite nas configurações do seu celular.
                </div>
            </div>
            
            <p id="permStatus" class="text-[10px] text-slate-600 uppercase font-black tracking-widest">Aguardando Autorização Nativa</p>
        </section>

        <!-- SECTION: MENU -->
        <section id="secMenu" class="hidden flex flex-col gap-4 py-8 animate-in slide-in-from-bottom-4 duration-500">
            <button id="btnModeCamera" class="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group shadow-lg">
                <i data-lucide="camera" class="text-blue-500 w-10 h-10 group-hover:scale-110 transition-transform"></i>
                <div class="text-left">
                    <span class="block text-xl font-bold text-slate-100">Modo Câmera</span>
                    <span class="text-[10px] text-slate-500 uppercase font-black tracking-widest leading-none">Transmitir Imagem</span>
                </div>
            </button>
            <button id="btnModeViewer" class="flex items-center gap-5 p-6 bg-slate-900 border border-slate-800 rounded-3xl hover:bg-slate-800 active:scale-95 transition-all group shadow-lg">
                <i data-lucide="monitor-play" class="text-green-500 w-10 h-10 group-hover:scale-110 transition-transform"></i>
                <div class="text-left">
                    <span class="block text-xl font-bold text-slate-100">Modo Monitor</span>
                    <span class="text-[10px] text-slate-500 uppercase font-black tracking-widest leading-none">Ver Câmeras Remotas</span>
                </div>
            </button>
        </section>

        <!-- SECTION: SETUP ROOM -->
        <section id="secSetup" class="hidden flex flex-col gap-6 animate-in zoom-in-95 duration-300">
            <div class="bg-slate-900 p-6 rounded-[3rem] border border-slate-800 space-y-6 shadow-2xl">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase px-4 tracking-widest">Código de Acesso do Grupo</label>
                    <input type="text" id="inputRoomId" placeholder="EX: SEG-01" class="w-full bg-slate-950 border border-slate-800 rounded-3xl py-6 text-3xl font-mono text-center outline-none focus:ring-4 focus:ring-blue-600/20 transition-all uppercase placeholder:opacity-10">
                </div>
                <button id="btnStartStreaming" class="w-full py-6 rounded-3xl font-black text-sm tracking-[0.3em] shadow-xl active:scale-95 transition-all disabled:opacity-30 uppercase">
                    Conectar
                </button>
            </div>
            <p id="setupStatus" class="text-[10px] text-slate-500 text-center font-bold tracking-[0.2em] uppercase">Sistema Criptografado</p>
        </section>

        <!-- SECTION: STREAMING AREA -->
        <section id="secStreaming" class="hidden flex flex-col gap-6">
            <div id="streamingContainer" class="relative min-h-[400px] bg-slate-900 rounded-[3rem] border border-slate-800 shadow-2xl overflow-hidden flex items-center justify-center">
                
                <!-- CAMERA VIEW -->
                <div id="viewCamera" class="hidden flex flex-col items-center gap-6 p-10 text-center">
                    <audio id="remoteAudio" autoplay playsinline></audio>
                    <div class="relative">
                        <div class="w-24 h-24 bg-blue-600/10 rounded-full flex items-center justify-center border-2 border-blue-600/50 animate-pulse-slow">
                            <i data-lucide="video" class="text-blue-500 w-12 h-12"></i>
                        </div>
                        <div id="audioIndicator" class="hidden absolute -top-2 -right-2 bg-green-500 p-2 rounded-full border-4 border-slate-900">
                            <i data-lucide="volume-2" class="text-white w-4 h-4"></i>
                        </div>
                    </div>
                    <div class="px-6 py-2 bg-blue-600/20 rounded-full border border-blue-500/30">
                        <span class="text-[10px] font-black text-blue-400 tracking-[0.3em] uppercase">Transmissão Ativa</span>
                    </div>
                    <button id="btnActivateReturnAudio" class="flex items-center gap-3 bg-white text-black px-6 py-5 rounded-2xl font-black text-[10px] tracking-widest active:scale-95 transition-all shadow-2xl">
                        <i data-lucide="headphones" class="w-4 h-4"></i> ATIVAR ÁUDIO DE RETORNO
                    </button>
                    <p id="returnAudioMsg" class="hidden text-[10px] text-slate-500 uppercase font-bold opacity-50 max-w-[220px]">
                        Você ouvirá a voz do monitor agora.
                    </p>
                </div>

                <!-- VIEWER GRID -->
                <div id="viewViewer" class="hidden w-full h-full p-2 grid grid-cols-1 gap-2">
                    <!-- Peer videos injected here -->
                </div>
            </div>
        </section>

    </main>

    <footer class="p-10 text-slate-800 text-[8px] uppercase tracking-[0.4em] font-black text-center opacity-40">
        P2P Security WebApp • v3.0 Optimized
    </footer>

    <!-- FIREBASE SDKS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'securiteview-p2p';
        const rtcConfig = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        // STATE
        let currentUser = null;
        let currentMode = 'permissions'; 
        let currentRoomId = '';
        let localStream = null;
        let peerConnections = {};
        let cameraId = crypto.randomUUID();
        let audioContext = null;

        // DOM ELEMENTS
        const sections = {
            permissions: document.getElementById('secPermissions'),
            menu: document.getElementById('secMenu'),
            setup: document.getElementById('secSetup'),
            streaming: document.getElementById('secStreaming'),
            viewCamera: document.getElementById('viewCamera'),
            viewViewer: document.getElementById('viewViewer')
        };

        const updateUI = (mode) => {
            Object.keys(sections).forEach(k => sections[k].classList.add('hidden'));
            if (mode === 'permissions') sections.permissions.classList.remove('hidden');
            if (mode === 'menu') sections.menu.classList.remove('hidden');
            if (mode === 'camera' || mode === 'viewer') sections.setup.classList.remove('hidden');
            if (mode === 'streaming_camera') {
                sections.streaming.classList.remove('hidden');
                sections.viewCamera.classList.remove('hidden');
            }
            if (mode === 'streaming_viewer') {
                sections.streaming.classList.remove('hidden');
                sections.viewViewer.classList.remove('hidden');
            }
            document.getElementById('btnExit').classList.toggle('hidden', mode === 'permissions' || mode === 'menu');
            lucide.createIcons();
        };

        // AUDIO POLICY (Para Mobile)
        const resumeAudio = async () => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
            document.querySelectorAll('audio, video').forEach(el => {
                el.muted = false;
                el.play().catch(() => {});
            });
        };

        // AUTH
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, user => { currentUser = user; });
        initAuth();

        // SISTEMA DE PERMISSÃO MOBILE NATIVO
        document.getElementById('btnGrantPermissions').onclick = async () => {
            const errorBox = document.getElementById('errorBox');
            errorBox.classList.add('hidden');
            
            try {
                // Tenta forçar o prompt do sistema para Câmera e Microfone
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: true 
                });
                
                // Se chegou aqui, o usuário clicou em "Permitir"
                stream.getTracks().forEach(t => t.stop()); // Para o preview temporário
                currentMode = 'menu';
                updateUI('menu');
                resumeAudio();
            } catch (e) {
                console.error("Permissão negada:", e);
                errorBox.classList.remove('hidden');
                document.getElementById('permStatus').innerText = "Acesso Negado";
            }
        };

        // NAVIGATION
        document.getElementById('btnModeCamera').onclick = () => {
            currentMode = 'camera';
            const btn = document.getElementById('btnStartStreaming');
            btn.innerText = 'ATIVAR TRANSMISSOR';
            btn.className = "w-full py-6 rounded-3xl font-black text-sm tracking-[0.2em] shadow-xl active:scale-95 transition-all bg-blue-600 shadow-blue-900/40 uppercase";
            updateUI('camera');
        };

        document.getElementById('btnModeViewer').onclick = () => {
            currentMode = 'viewer';
            const btn = document.getElementById('btnStartStreaming');
            btn.innerText = 'ATIVAR MONITOR';
            btn.className = "w-full py-6 rounded-3xl font-black text-sm tracking-[0.2em] shadow-xl active:scale-95 transition-all bg-green-600 shadow-green-900/40 uppercase";
            updateUI('viewer');
        };

        document.getElementById('btnExit').onclick = () => {
            if(confirm("Encerrar sessão?")) location.reload(); 
        };

        // START ENGINE
        document.getElementById('btnStartStreaming').onclick = async () => {
            currentRoomId = document.getElementById('inputRoomId').value.toUpperCase().trim();
            if (!currentRoomId || !currentUser) return;
            await resumeAudio();
            
            if (currentMode === 'camera') startCameraMode();
            else startViewerMode();
        };

        // HELPERS
        const getPeerDoc = (room, pId) => doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room, 'peers', pId);
        const getPeersCol = (room) => collection(db, 'artifacts', appId, 'public', 'data', 'rooms', room, 'peers');

        // CAMERA MODE
        async function startCameraMode() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" },
                    audio: { echoCancellation: true, noiseSuppression: true }
                });

                updateUI('streaming_camera');
                const pc = new RTCPeerConnection(rtcConfig);
                peerConnections[cameraId] = pc;
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                pc.addTransceiver('audio', { direction: 'recvonly' });

                pc.ontrack = (e) => {
                    if (e.track.kind === 'audio') {
                        const audio = document.getElementById('remoteAudio');
                        audio.srcObject = e.streams[0];
                        audio.play().then(() => {
                            document.getElementById('audioIndicator').classList.remove('hidden');
                            document.getElementById('btnActivateReturnAudio').classList.add('hidden');
                            document.getElementById('returnAudioMsg').classList.remove('hidden');
                        }).catch(() => {});
                    }
                };

                const docRef = getPeerDoc(currentRoomId, cameraId);
                pc.onicecandidate = e => e.candidate && addDoc(collection(docRef, 'offerCandidates'), e.candidate.toJSON());

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await setDoc(docRef, {
                    cameraId, offer: { sdp: offer.sdp, type: offer.type },
                    createdBy: currentUser.uid, timestamp: Date.now(),
                    controls: { zoom: 1, rotation: 0, remoteMic: true, anchorMic: true }
                });

                onSnapshot(docRef, async snap => {
                    const data = snap.data();
                    if (data?.answer && pc.signalingState !== 'stable') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });

                onSnapshot(collection(docRef, 'answerCandidates'), s => s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));

            } catch (e) { alert("Erro ao abrir hardware."); }
        }

        // VIEWER MODE
        async function startViewerMode() {
            updateUI('streaming_viewer');
            let anchorStream = null;
            try { anchorStream = await navigator.mediaDevices.getUserMedia({ audio: true }); } catch(e){}

            onSnapshot(getPeersCol(currentRoomId), snap => {
                snap.docChanges().forEach(async change => {
                    if (change.type !== 'added') return;
                    const pId = change.doc.id;
                    const pData = change.doc.data();
                    if (peerConnections[pId] || !pData.offer) return;

                    const pc = new RTCPeerConnection(rtcConfig);
                    peerConnections[pId] = pc;
                    if (anchorStream) anchorStream.getTracks().forEach(t => pc.addTrack(t, anchorStream));

                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = "relative bg-black rounded-3xl overflow-hidden aspect-video border border-white/5 shadow-2xl animate-in zoom-in-90";
                    const video = document.createElement('video');
                    video.autoplay = true;
                    video.playsInline = true;
                    video.className = "w-full h-full object-contain";
                    videoWrapper.appendChild(video);
                    document.getElementById('viewViewer').appendChild(videoWrapper);

                    pc.ontrack = e => { video.srcObject = e.streams[0]; video.play().catch(()=>{}); };

                    const docRef = getPeerDoc(currentRoomId, pId);
                    pc.onicecandidate = e => e.candidate && addDoc(collection(docRef, 'answerCandidates'), e.candidate.toJSON());
                    await pc.setRemoteDescription(new RTCSessionDescription(pData.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await updateDoc(docRef, { answer: { sdp: answer.sdp, type: answer.type } });

                    onSnapshot(collection(docRef, 'offerCandidates'), s => s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
                });
            });
        }

        document.getElementById('btnActivateReturnAudio').onclick = resumeAudio;
        window.addEventListener('touchstart', resumeAudio, { once: true });
        lucide.createIcons();
    </script>
</body>
</html>